<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashUp Agent - Kenya Payment Reconciliation</title>
    
    <!-- CSS Framework -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .status-pending { color: #f59e0b; }
        .status-matched { color: #10b981; }
        .status-unmatched { color: #ef4444; }
        .status-partial { color: #8b5cf6; }
        
        .confidence-high { background-color: #d1fae5; color: #065f46; }
        .confidence-medium { background-color: #fef3c7; color: #92400e; }
        .confidence-low { background-color: #fee2e2; color: #991b1b; }
        
        .mobile-hidden { display: block; }
        
        @media (max-width: 768px) {
            .mobile-hidden { display: none; }
            .mobile-stack { flex-direction: column; }
            .mobile-full { width: 100%; }
        }
        
        .flag-kenya {
            background: linear-gradient(to bottom, #000000 33%, #ff0000 33%, #ff0000 66%, #00ff00 66%);
            width: 24px;
            height: 16px;
            border-radius: 2px;
        }
        
        .mpesa-green { color: #00a651; }
        .equity-blue { color: #1e40af; }
        .kcb-blue { color: #0369a1; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-coins text-white text-2xl mr-3"></i>
                        <span class="text-white text-xl font-bold">CashUp Agent</span>
                        <div class="flag-kenya ml-2"></div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-white text-sm">
                        <i class="fas fa-user-circle mr-1"></i>
                        EABL Finance Team
                    </div>
                    <button class="text-white hover:text-gray-200">
                        <i class="fas fa-bell text-lg"></i>
                    </button>
                    <button class="text-white hover:text-gray-200">
                        <i class="fas fa-cog text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white overflow-hidden shadow-sm rounded-lg card-hover">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-money-bill-wave text-green-500 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-500">Today's Payments</div>
                            <div class="text-2xl font-bold text-gray-900" id="todayPayments">247</div>
                            <div class="text-sm text-green-600">KES 1,250,000</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow-sm rounded-lg card-hover">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-blue-500 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-500">Auto-Matched</div>
                            <div class="text-2xl font-bold text-gray-900" id="autoMatched">189</div>
                            <div class="text-sm text-blue-600">76.5% success rate</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow-sm rounded-lg card-hover">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-500">Exceptions</div>
                            <div class="text-2xl font-bold text-gray-900" id="exceptions">58</div>
                            <div class="text-sm text-yellow-600">Needs review</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow-sm rounded-lg card-hover">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-purple-500 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-500">Avg Processing Time</div>
                            <div class="text-2xl font-bold text-gray-900">2.3s</div>
                            <div class="text-sm text-purple-600">95% under 5s</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Controls -->
        <div class="bg-white shadow-sm rounded-lg mb-6">
            <div class="p-6">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex flex-wrap items-center gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Payment Source</label>
                            <select id="sourceFilter" class="border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All Sources</option>
                                <option value="mpesa" class="mpesa-green">üü¢ M-Pesa</option>
                                <option value="equity" class="equity-blue">üîµ Equity Bank</option>
                                <option value="kcb" class="kcb-blue">üîµ KCB</option>
                                <option value="coop">üü° Co-operative Bank</option>
                                <option value="airtel">üî¥ Airtel Money</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="statusFilter" class="border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All Status</option>
                                <option value="matched">‚úÖ Matched</option>
                                <option value="pending">‚è≥ Pending Review</option>
                                <option value="unmatched">‚ùå Unmatched</option>
                                <option value="partial">üîÑ Partial</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                            <select id="dateFilter" class="border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button id="refreshBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center gap-2">
                            <i class="fas fa-sync-alt"></i>
                            <span class="mobile-hidden">Refresh</span>
                        </button>
                        
                        <button id="exportBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md flex items-center gap-2">
                            <i class="fas fa-download"></i>
                            <span class="mobile-hidden">Export</span>
                        </button>
                        
                        <button id="bulkActionsBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md flex items-center gap-2">
                            <i class="fas fa-tasks"></i>
                            <span class="mobile-hidden">Bulk Actions</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Reconciliation Table -->
        <div class="bg-white shadow-sm rounded-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Payment Reconciliation</h2>
                <p class="text-sm text-gray-600">Review and approve payment matches</p>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" id="selectAll" class="rounded">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider mobile-hidden">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider mobile-hidden">Invoice Match</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Dynamic content will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6 rounded-b-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <p class="text-sm text-gray-700">
                        Showing <span class="font-medium">1</span> to <span class="font-medium">20</span> of <span class="font-medium">247</span> results
                    </p>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="bg-white border border-gray-300 text-gray-500 hover:bg-gray-50 px-3 py-2 rounded-md text-sm">
                        Previous
                    </button>
                    <button class="bg-blue-500 border border-blue-500 text-white px-3 py-2 rounded-md text-sm">1</button>
                    <button class="bg-white border border-gray-300 text-gray-500 hover:bg-gray-50 px-3 py-2 rounded-md text-sm">2</button>
                    <button class="bg-white border border-gray-300 text-gray-500 hover:bg-gray-50 px-3 py-2 rounded-md text-sm">3</button>
                    <button class="bg-white border border-gray-300 text-gray-500 hover:bg-gray-50 px-3 py-2 rounded-md text-sm">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Detail Modal -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Payment Details</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="modalContent" class="space-y-6">
                    <!-- Dynamic modal content -->
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="rejectMatch" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md">
                        <i class="fas fa-times mr-1"></i> Reject
                    </button>
                    <button id="approveMatch" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md">
                        <i class="fas fa-check mr-1"></i> Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Notification Panel (Kenya-specific) -->
    <div id="whatsappPanel" class="fixed bottom-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg max-w-sm hidden">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center">
                <i class="fab fa-whatsapp text-xl mr-2"></i>
                <span class="font-medium">WhatsApp Alert</span>
            </div>
            <button id="closeWhatsApp" class="text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <p id="whatsappMessage" class="text-sm">New payment exception requires attention</p>
        <button id="whatsappReply" class="bg-white text-green-500 px-3 py-1 rounded-md text-sm mt-2 hover:bg-gray-100">
            Reply
        </button>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    
    <script>
        // Kenya Payment Reconciliation App
        class KenyaPaymentReconciliation {
            constructor() {
                this.baseURL = '/api/v1';
                this.currentPayments = [];
                this.filters = {};
                
                this.init();
                this.loadPayments();
                this.setupEventListeners();
                this.startRealTimeUpdates();
            }
            
            init() {
                console.log('üá∞üá™ Kenya Payment Reconciliation System Initialized');
            }
            
            setupEventListeners() {
                // Filter controls
                document.getElementById('sourceFilter').addEventListener('change', (e) => {
                    this.filters.source = e.target.value;
                    this.loadPayments();
                });
                
                document.getElementById('statusFilter').addEventListener('change', (e) => {
                    this.filters.status = e.target.value;
                    this.loadPayments();
                });
                
                document.getElementById('dateFilter').addEventListener('change', (e) => {
                    this.filters.date = e.target.value;
                    this.loadPayments();
                });
                
                // Action buttons
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadPayments();
                });
                
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportPayments();
                });
                
                document.getElementById('bulkActionsBtn').addEventListener('click', () => {
                    this.showBulkActions();
                });
                
                // Modal controls
                document.getElementById('closeModal').addEventListener('click', () => {
                    this.closeModal();
                });
                
                document.getElementById('approveMatch').addEventListener('click', () => {
                    this.approveCurrentMatch();
                });
                
                document.getElementById('rejectMatch').addEventListener('click', () => {
                    this.rejectCurrentMatch();
                });
                
                // WhatsApp panel
                document.getElementById('closeWhatsApp').addEventListener('click', () => {
                    document.getElementById('whatsappPanel').classList.add('hidden');
                });
                
                document.getElementById('whatsappReply').addEventListener('click', () => {
                    this.openWhatsAppReply();
                });
            }
            
            async loadPayments() {
                try {
                    const response = await axios.get(`${this.baseURL}/payments`, {
                        params: this.filters
                    });
                    
                    this.currentPayments = response.data.payments || this.getSamplePayments();
                    this.renderPaymentsTable();
                    this.updateDashboardStats();
                    
                } catch (error) {
                    console.error('Error loading payments:', error);
                    // Use sample data for demo
                    this.currentPayments = this.getSamplePayments();
                    this.renderPaymentsTable();
                }
            }
            
            getSamplePayments() {
                return [
                    {
                        id: 'PAY001',
                        source: 'mpesa',
                        reference: 'QEJ7H8KL9M',
                        amount: 5000.00,
                        currency: 'KES',
                        customer: {
                            name: 'JOHN DOE',
                            phone: '+254712345678'
                        },
                        invoice_match: {
                            invoice_number: 'INV-2024-001',
                            confidence: 0.94
                        },
                        status: 'pending',
                        timestamp: new Date(),
                        memo: 'Payment for invoice INV001'
                    },
                    {
                        id: 'PAY002',
                        source: 'equity',
                        reference: 'EQB_20240815_25000',
                        amount: 25000.00,
                        currency: 'KES',
                        customer: {
                            name: 'ACME SUPPLIERS LTD',
                            account: '1234567890'
                        },
                        invoice_match: {
                            invoice_number: 'INV-2024-002',
                            confidence: 0.89
                        },
                        status: 'matched',
                        timestamp: new Date(),
                        memo: 'RTGS FROM ACME SUPPLIERS LTD'
                    },
                    {
                        id: 'PAY003',
                        source: 'airtel',
                        reference: 'AM789123',
                        amount: 1500.00,
                        currency: 'KES',
                        customer: {
                            name: 'MARY WANJIKU',
                            phone: '+254798765432'
                        },
                        invoice_match: null,
                        status: 'unmatched',
                        timestamp: new Date(),
                        memo: 'Airtel Money transfer'
                    },
                    {
                        id: 'PAY004',
                        source: 'kcb',
                        reference: 'KCB_20240815_7500',
                        amount: 7500.00,
                        currency: 'KES',
                        customer: {
                            name: 'SAFARI LOGISTICS',
                            account: '0987654321'
                        },
                        invoice_match: {
                            invoice_number: 'INV-2024-003',
                            confidence: 0.76
                        },
                        status: 'partial',
                        timestamp: new Date(),
                        memo: 'Standing Order Payment'
                    }
                ];
            }
            
            renderPaymentsTable() {
                const tbody = document.getElementById('paymentsTableBody');
                tbody.innerHTML = '';
                
                this.currentPayments.forEach(payment => {
                    const row = this.createPaymentRow(payment);
                    tbody.appendChild(row);
                });
            }
            
            createPaymentRow(payment) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const sourceIcon = this.getSourceIcon(payment.source);
                const statusBadge = this.getStatusBadge(payment.status);
                const confidenceBadge = payment.invoice_match ? 
                    this.getConfidenceBadge(payment.invoice_match.confidence) : 
                    '<span class="text-gray-400">-</span>';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="payment-checkbox rounded" data-payment-id="${payment.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <span class="mr-2">${sourceIcon}</span>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${payment.reference}</div>
                                <div class="text-sm text-gray-500">${this.formatTimestamp(payment.timestamp)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${payment.customer.name}</div>
                            <div class="text-sm text-gray-500">
                                ${payment.customer.phone || payment.customer.account || ''}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap mobile-hidden">
                        <div class="text-sm font-medium text-gray-900">
                            ${this.formatCurrency(payment.amount, payment.currency)}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap mobile-hidden">
                        <div class="text-sm text-gray-900">
                            ${payment.invoice_match ? payment.invoice_match.invoice_number : '-'}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${confidenceBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${statusBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="app.showPaymentDetails('${payment.id}')" 
                                class="text-blue-600 hover:text-blue-900 mr-2">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${payment.status === 'pending' ? `
                            <button onclick="app.quickApprove('${payment.id}')" 
                                    class="text-green-600 hover:text-green-900 mr-2">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                
                return row;
            }
            
            getSourceIcon(source) {
                const icons = {
                    'mpesa': '<span class="mpesa-green">üì±</span>',
                    'equity': '<span class="equity-blue">üè¶</span>',
                    'kcb': '<span class="kcb-blue">üèõÔ∏è</span>',
                    'coop': '<span class="text-yellow-600">üè™</span>',
                    'airtel': '<span class="text-red-500">üì±</span>',
                    'absa': '<span class="text-red-600">üè¶</span>'
                };
                return icons[source] || 'üí≥';
            }
            
            getStatusBadge(status) {
                const badges = {
                    'matched': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">‚úÖ Matched</span>',
                    'pending': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">‚è≥ Pending</span>',
                    'unmatched': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">‚ùå Unmatched</span>',
                    'partial': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">üîÑ Partial</span>'
                };
                return badges[status] || status;
            }
            
            getConfidenceBadge(confidence) {
                const percentage = Math.round(confidence * 100);
                let className, icon;
                
                if (confidence >= 0.9) {
                    className = 'confidence-high';
                    icon = 'üü¢';
                } else if (confidence >= 0.7) {
                    className = 'confidence-medium';
                    icon = 'üü°';
                } else {
                    className = 'confidence-low';
                    icon = 'üî¥';
                }
                
                return `<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium ${className}">
                    ${icon} ${percentage}%
                </span>`;
            }
            
            formatCurrency(amount, currency = 'KES') {
                return new Intl.NumberFormat('en-KE', {
                    style: 'currency',
                    currency: currency
                }).format(amount);
            }
            
            formatTimestamp(timestamp) {
                return new Date(timestamp).toLocaleDateString('en-KE', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            showPaymentDetails(paymentId) {
                const payment = this.currentPayments.find(p => p.id === paymentId);
                if (!payment) return;
                
                const modal = document.getElementById('paymentModal');
                const content = document.getElementById('modalContent');
                
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 mb-4">Payment Information</h4>
                            <dl class="space-y-3">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Source</dt>
                                    <dd class="text-sm text-gray-900 flex items-center">
                                        ${this.getSourceIcon(payment.source)} 
                                        <span class="ml-2">${payment.source.toUpperCase()}</span>
                                    </dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Reference</dt>
                                    <dd class="text-sm text-gray-900">${payment.reference}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Amount</dt>
                                    <dd class="text-sm text-gray-900">${this.formatCurrency(payment.amount, payment.currency)}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Customer</dt>
                                    <dd class="text-sm text-gray-900">${payment.customer.name}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Contact</dt>
                                    <dd class="text-sm text-gray-900">${payment.customer.phone || payment.customer.account || 'N/A'}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Memo</dt>
                                    <dd class="text-sm text-gray-900">${payment.memo}</dd>
                                </div>
                            </dl>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 mb-4">Match Information</h4>
                            ${payment.invoice_match ? `
                                <dl class="space-y-3">
                                    <div>
                                        <dt class="text-sm font-medium text-gray-500">Invoice Number</dt>
                                        <dd class="text-sm text-gray-900">${payment.invoice_match.invoice_number}</dd>
                                    </div>
                                    <div>
                                        <dt class="text-sm font-medium text-gray-500">Confidence Score</dt>
                                        <dd class="text-sm text-gray-900">${this.getConfidenceBadge(payment.invoice_match.confidence)}</dd>
                                    </div>
                                    <div>
                                        <dt class="text-sm font-medium text-gray-500">Match Rule</dt>
                                        <dd class="text-sm text-gray-900">Exact amount + customer match</dd>
                                    </div>
                                </dl>
                            ` : `
                                <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                                    <div class="flex">
                                        <i class="fas fa-exclamation-triangle text-yellow-400 mr-3 mt-1"></i>
                                        <div>
                                            <h3 class="text-sm font-medium text-yellow-800">No Match Found</h3>
                                            <p class="text-sm text-yellow-700 mt-1">This payment could not be automatically matched to an invoice.</p>
                                        </div>
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
                this.currentPayment = payment;
            }
            
            closeModal() {
                document.getElementById('paymentModal').classList.add('hidden');
                this.currentPayment = null;
            }
            
            async approveCurrentMatch() {
                if (!this.currentPayment) return;
                
                try {
                    await axios.post(`${this.baseURL}/payments/${this.currentPayment.id}/approve`);
                    
                    // Update local data
                    const payment = this.currentPayments.find(p => p.id === this.currentPayment.id);
                    if (payment) {
                        payment.status = 'matched';
                    }
                    
                    this.showNotification('Payment approved successfully', 'success');
                    this.closeModal();
                    this.renderPaymentsTable();
                    this.updateDashboardStats();
                    
                } catch (error) {
                    console.error('Error approving payment:', error);
                    this.showNotification('Error approving payment', 'error');
                }
            }
            
            async rejectCurrentMatch() {
                if (!this.currentPayment) return;
                
                try {
                    await axios.post(`${this.baseURL}/payments/${this.currentPayment.id}/reject`);
                    
                    // Update local data
                    const payment = this.currentPayments.find(p => p.id === this.currentPayment.id);
                    if (payment) {
                        payment.status = 'unmatched';
                        payment.invoice_match = null;
                    }
                    
                    this.showNotification('Payment match rejected', 'warning');
                    this.closeModal();
                    this.renderPaymentsTable();
                    
                } catch (error) {
                    console.error('Error rejecting payment:', error);
                    this.showNotification('Error rejecting payment', 'error');
                }
            }
            
            async quickApprove(paymentId) {
                const payment = this.currentPayments.find(p => p.id === paymentId);
                if (!payment || !payment.invoice_match || payment.invoice_match.confidence < 0.8) {
                    this.showNotification('Cannot quick approve - low confidence match', 'warning');
                    return;
                }
                
                try {
                    await axios.post(`${this.baseURL}/payments/${paymentId}/approve`);
                    
                    payment.status = 'matched';
                    this.showNotification('Payment approved', 'success');
                    this.renderPaymentsTable();
                    
                } catch (error) {
                    console.error('Error in quick approve:', error);
                    this.showNotification('Error approving payment', 'error');
                }
            }
            
            updateDashboardStats() {
                const stats = {
                    total: this.currentPayments.length,
                    matched: this.currentPayments.filter(p => p.status === 'matched').length,
                    pending: this.currentPayments.filter(p => p.status === 'pending').length,
                    unmatched: this.currentPayments.filter(p => p.status === 'unmatched').length
                };
                
                document.getElementById('todayPayments').textContent = stats.total;
                document.getElementById('autoMatched').textContent = stats.matched;
                document.getElementById('exceptions').textContent = stats.pending + stats.unmatched;
            }
            
            exportPayments() {
                // Create CSV export
                const headers = ['Reference', 'Source', 'Customer', 'Amount', 'Currency', 'Status', 'Invoice', 'Confidence'];
                const rows = this.currentPayments.map(p => [
                    p.reference,
                    p.source,
                    p.customer.name,
                    p.amount,
                    p.currency,
                    p.status,
                    p.invoice_match ? p.invoice_match.invoice_number : '',
                    p.invoice_match ? Math.round(p.invoice_match.confidence * 100) + '%' : ''
                ]);
                
                const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `payments_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                window.URL.revokeObjectURL(url);
                this.showNotification('Export completed', 'success');
            }
            
            showBulkActions() {
                const selectedPayments = Array.from(document.querySelectorAll('.payment-checkbox:checked'))
                    .map(cb => cb.dataset.paymentId);
                
                if (selectedPayments.length === 0) {
                    this.showNotification('Please select payments first', 'warning');
                    return;
                }
                
                // Show bulk actions menu (simplified for demo)
                const actions = ['Approve All', 'Reject All', 'Export Selected'];
                const action = prompt(`Select action for ${selectedPayments.length} payments:\n${actions.join('\n')}`);
                
                if (action === 'Approve All') {
                    this.bulkApprove(selectedPayments);
                } else if (action === 'Export Selected') {
                    this.exportSelected(selectedPayments);
                }
            }
            
            async bulkApprove(paymentIds) {
                try {
                    await axios.post(`${this.baseURL}/payments/bulk-approve`, { payment_ids: paymentIds });
                    
                    // Update local data
                    paymentIds.forEach(id => {
                        const payment = this.currentPayments.find(p => p.id === id);
                        if (payment) payment.status = 'matched';
                    });
                    
                    this.showNotification(`${paymentIds.length} payments approved`, 'success');
                    this.renderPaymentsTable();
                    
                } catch (error) {
                    console.error('Bulk approve error:', error);
                    this.showNotification('Error in bulk approval', 'error');
                }
            }
            
            startRealTimeUpdates() {
                // Simulate real-time updates every 30 seconds
                setInterval(() => {
                    // this.loadPayments();
                    
                    // Occasionally show WhatsApp notifications for exceptions
                    if (Math.random() < 0.1) { // 10% chance
                        this.showWhatsAppNotification();
                    }
                }, 30000);
            }
            
            showWhatsAppNotification() {
                const messages = [
                    'New M-Pesa payment KES 15,000 needs review',
                    'Large payment KES 150,000 from new customer',
                    'Multiple payments from same customer detected',
                    'System matched 45 payments automatically'
                ];
                
                const message = messages[Math.floor(Math.random() * messages.length)];
                document.getElementById('whatsappMessage').textContent = message;
                document.getElementById('whatsappPanel').classList.remove('hidden');
            }
            
            openWhatsAppReply() {
                // Simulate opening WhatsApp
                window.open(`https://wa.me/254700123456?text=Regarding payment exception: I need to review this payment.`, '_blank');
                document.getElementById('whatsappPanel').classList.add('hidden');
            }
            
            showNotification(message, type = 'info') {
                // Create simple notification
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
                    type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' :
                    type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
                } text-white`;
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }
        
        // Initialize the app
        const app = new KenyaPaymentReconciliation();
    </script>
</body>
</html>